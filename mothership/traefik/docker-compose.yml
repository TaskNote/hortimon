version: '3.7'

services:
  traefik:
    image: traefik:v2.2
    restart: always
    command:
      #- --log.level=DEBUG
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.defaultrule=PathPrefix(`/{{ index .Labels "com.docker.compose.service" }}`)
      - --entryPoints.web.address=:80
      # default middleware for all dynamic routers. add slash and strip prefix.
      # we expect all backends to listen on bare slash route.
      - --entrypoints.web.http.middlewares=my-chain@docker
    labels:
      traefik.http.middlewares.add-slash.redirectregex.regex: ^(https?://[^/]+/[\w-]+)$$
      traefik.http.middlewares.add-slash.redirectregex.replacement: $${1}/
      traefik.http.middlewares.add-slash.redirectregex.permanent: true
      traefik.http.middlewares.strip.stripprefixregex.regex: /[\w-]+
      traefik.http.middlewares.my-chain.chain.middlewares: add-slash,strip
    ports:
      # The HTTP port
      - "80:80"
      # The Web UI (enabled by --api.insecure=true)
      - "8080:8080"
    volumes:
      # Traefik listens to Docker events
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - isengard

  whoami:
    # A container that exposes an API to show its IP address
    image: containous/whoami
    restart: always
    networks:
      - isengard

networks:
  isengard:
    external: True
